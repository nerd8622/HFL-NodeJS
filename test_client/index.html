<!-- Copyright (c) 2023 David Canaday -->
<!DOCTYPE html>
<head>
    <title>HFL Client</title>
</head>
<body>
    <div class="container">
        <h1>HFL Client</h1>
        <pre class="console">
        </pre>
    </div>
    <script src="console.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
    <script>
        window.addEventListener("load", function () {
            ConsoleJS.init({selector: "pre.console"});
        });
    </script>
    <script type="module">
        var hash = window.location.hash.substring(1);
        if (!hash) hash = 3001;
        console.log(`Attempting connection to: ws://127.0.0.1:${hash}!`);
        import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
        const socket = io(`ws://127.0.0.1:${hash}`);

        const tensorSerializer = async (tensor) => {
            const data = await tensor.data();
            const tb64 = Buffer.from(new UInt8Array(data.buffer)).toString('base64');
            return {data: tb64, shape: s, ttype: typeof data};
        }

        const tensorUnSerializer = async (sdata) => {
            const raw = Uint8Array.from(atob(sdata.data), c => c.charCodeAt(0));
            return tf.tensor(raw, sdata.shape, sdata.ttype);
        }

        socket.on('download', async (message) =>{
            console.log("Received model from Edge Server!");
            const model = await tf.loadLayersModel(message.model);
            const {images: trainImages, labels: trainLabels} = message.data;
            const trImages = await tensorUnSerializer(trainImages);
            const trLabels = await tensorUnSerializer(trainLabels);
            //const trImages = tf.tensor2d(new Float32Array(Uint8Array.from(atob(trainImages), c => c.charCodeAt(0)).buffer), imagesShape);
            //const trLabels = tf.oneHot(tf.tensor1d(new Int32Array(Uint8Array.from(atob(trainLabels), c => c.charCodeAt(0)).buffer), 'int32'), LABEL_FLAT_SIZE).toFloat();
            console.log(model.summary());
            await model.compile({
                optimizer: 'adam',
                loss: 'categoricalCrossentropy',
                metrics: ['accuracy'],
            });
            await model.fit(trImages, trLabels);
            console.log(model.summary());
            await model.save(tf.io.browserHTTPRequest( 
                model.callback,
                {method: 'POST', headers: {'sid': socket.id}}
            ));
            console.log("Trained Model Uploaded to Edge Server!");
        });
    </script>
</body>
</html>
